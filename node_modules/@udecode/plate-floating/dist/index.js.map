{"version":3,"file":"index.js","sources":["../src/createVirtualElement.ts","../src/components/Popover.tsx","../src/components/ElementPopover.tsx","../src/utils/getRangeBoundingClientRect.ts","../src/utils/getSelectionBoundingClientRect.ts","../src/hooks/useVirtualFloating.ts"],"sourcesContent":["import { ClientRectObject } from '@floating-ui/core';\nimport { VirtualElement } from '@floating-ui/react';\n\nexport const getDefaultBoundingClientRect = (): ClientRectObject => ({\n  width: 0,\n  height: 0,\n  x: 0,\n  y: 0,\n  top: -9999,\n  left: -9999,\n  right: 9999,\n  bottom: 9999,\n});\n\nexport const createVirtualElement = (): VirtualElement => ({\n  getBoundingClientRect: getDefaultBoundingClientRect,\n});\n","import React, { cloneElement, ReactNode } from 'react';\nimport { createElementAs, HTMLPropsAs } from '@udecode/plate-common';\nimport {\n  autoUpdate,\n  flip,\n  offset,\n  shift,\n  useFloating,\n  UseFloatingProps,\n  useInteractions,\n} from '../libs/floating-ui';\n\nexport interface PopoverProps extends HTMLPropsAs<'div'> {\n  floatingOptions?: Partial<UseFloatingProps>;\n  disabled?: boolean;\n  content?: ReactNode;\n  children: JSX.Element;\n}\n\n/**\n * Popover displayed over children, rendering `content`\n */\nexport const Popover = ({\n  floatingOptions,\n  children,\n  content,\n  ...props\n}: PopoverProps) => {\n  const { x, y, refs, strategy } = useFloating({\n    middleware: [\n      offset(12),\n      flip({\n        padding: 96,\n      }),\n      shift(),\n    ],\n    whileElementsMounted: autoUpdate,\n    ...floatingOptions,\n  });\n\n  const { getReferenceProps } = useInteractions();\n\n  return (\n    <>\n      {cloneElement(\n        children,\n        getReferenceProps({ ref: refs.setReference, ...children.props })\n      )}\n\n      {floatingOptions?.open &&\n        createElementAs('div', {\n          ref: refs.setFloating,\n          style: {\n            position: strategy,\n            top: y ?? 0,\n            left: x ?? 0,\n            zIndex: 1,\n          },\n          contentEditable: false,\n          children: content,\n          ...props,\n        })}\n    </>\n  );\n};\n","import React from 'react';\nimport { isCollapsed, usePlateEditorState } from '@udecode/plate-common';\nimport { useReadOnly, useSelected } from 'slate-react';\nimport { Popover, PopoverProps } from './Popover';\n\n/**\n * Popover displayed over an element if:\n * - not disabled\n * - not read-only\n * - element selected\n */\nexport const ElementPopover = ({\n  floatingOptions = {},\n  ...props\n}: PopoverProps) => {\n  const { disabled } = props;\n\n  const readOnly = useReadOnly();\n  const selected = useSelected();\n\n  const editor = usePlateEditorState();\n\n  return (\n    <Popover\n      floatingOptions={{\n        open:\n          !disabled && !readOnly && selected && isCollapsed(editor.selection),\n        ...floatingOptions,\n      }}\n      {...props}\n    />\n  );\n};\n","import { ClientRectObject } from '@floating-ui/core';\nimport { toDOMRange, TReactEditor, Value } from '@udecode/plate-common';\nimport { Range } from 'slate';\nimport { getDefaultBoundingClientRect } from '../createVirtualElement';\n\n/**\n * Get bounding client rect by slate range\n */\nexport const getRangeBoundingClientRect = <V extends Value>(\n  editor: TReactEditor<V>,\n  at: Range | null\n): ClientRectObject => {\n  if (!at) return getDefaultBoundingClientRect();\n\n  const domRange = toDOMRange(editor, at);\n  if (!domRange) return getDefaultBoundingClientRect();\n\n  return domRange.getBoundingClientRect();\n};\n","import { ClientRectObject } from '@floating-ui/core';\nimport { getDefaultBoundingClientRect } from '../createVirtualElement';\n\n/**\n * Get bounding client rect of the window selection\n */\nexport const getSelectionBoundingClientRect = (): ClientRectObject => {\n  const domSelection = window.getSelection();\n\n  if (!domSelection || domSelection.rangeCount < 1) {\n    return getDefaultBoundingClientRect();\n  }\n\n  const domRange = domSelection.getRangeAt(0);\n\n  return domRange.getBoundingClientRect();\n};\n","import {\n  CSSProperties,\n  MutableRefObject,\n  useLayoutEffect,\n  useRef,\n  useState,\n} from 'react';\nimport { ClientRectObject } from '@floating-ui/core';\nimport { createVirtualElement } from '../createVirtualElement';\nimport {\n  autoUpdate,\n  ReferenceType,\n  useFloating,\n  UseFloatingProps,\n  UseFloatingReturn,\n  VirtualElement,\n} from '../libs/floating-ui';\nimport { getSelectionBoundingClientRect } from '../utils/index';\n\nexport interface UseVirtualFloatingOptions extends Partial<UseFloatingProps> {\n  getBoundingClientRect?: () => ClientRectObject;\n  open?: boolean;\n}\n\nexport interface UseVirtualFloatingReturn<\n  RT extends ReferenceType = ReferenceType\n> extends UseFloatingReturn<RT> {\n  virtualElementRef: MutableRefObject<VirtualElement>;\n  style: CSSProperties;\n}\n\n/**\n * `useFloating` with a controlled virtual element. Used to follow cursor position.\n *\n * Default options:\n * - `whileElementsMounted: autoUpdate`\n *\n * Additional options:\n * - `getBoundingClientRect` to get the bounding client rect.\n * - `hidden` to hide the floating element\n *\n * Additional returns:\n * - `style` to apply to the floating element\n * - `virtualElementRef`\n *\n * @see useFloating\n * @see https://floating-ui.com/docs/react-dom#virtual-element\n */\nexport const useVirtualFloating = <RT extends ReferenceType = ReferenceType>({\n  getBoundingClientRect = getSelectionBoundingClientRect,\n  ...floatingOptions\n}: UseVirtualFloatingOptions): UseVirtualFloatingReturn<RT> => {\n  const virtualElementRef = useRef<RT>(createVirtualElement() as RT);\n  const [visible, setVisible] = useState(true);\n\n  const floatingResult = useFloating<RT>({\n    // update on scroll and resize\n    whileElementsMounted: autoUpdate,\n    ...floatingOptions,\n  });\n\n  const { refs, middlewareData, strategy, x, y, update } = floatingResult;\n\n  useLayoutEffect(() => {\n    virtualElementRef.current.getBoundingClientRect = getBoundingClientRect;\n  }, [getBoundingClientRect, update]);\n\n  useLayoutEffect(() => {\n    refs.setReference(virtualElementRef.current);\n  }, [refs]);\n\n  useLayoutEffect(() => {\n    if (!middlewareData?.hide) return;\n\n    const { referenceHidden } = middlewareData.hide;\n\n    setVisible(!referenceHidden);\n  }, [middlewareData.hide]);\n\n  return {\n    ...floatingResult,\n    virtualElementRef,\n    style: {\n      position: strategy,\n      top: y ?? 0,\n      left: x ?? 0,\n      display: floatingOptions.open === false ? 'none' : undefined,\n      visibility: !visible ? 'hidden' : undefined,\n    },\n  };\n};\n"],"names":["getDefaultBoundingClientRect","width","height","x","y","top","left","right","bottom","createVirtualElement","getBoundingClientRect","Popover","floatingOptions","children","content","props","refs","strategy","useFloating","middleware","offset","flip","padding","shift","whileElementsMounted","autoUpdate","getReferenceProps","useInteractions","React","cloneElement","ref","setReference","open","createElementAs","setFloating","style","position","zIndex","contentEditable","ElementPopover","disabled","readOnly","useReadOnly","selected","useSelected","editor","usePlateEditorState","isCollapsed","selection","getRangeBoundingClientRect","at","domRange","toDOMRange","getSelectionBoundingClientRect","domSelection","window","getSelection","rangeCount","getRangeAt","useVirtualFloating","virtualElementRef","useRef","visible","setVisible","useState","floatingResult","middlewareData","update","useLayoutEffect","current","hide","referenceHidden","display","undefined","visibility"],"mappings":"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"}